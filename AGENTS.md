# AGENTS.md

## Project Overview

This repository generates JavaScript/TypeScript SDKs for Entrust Identity as a Service (IDaaS) APIs. It's a project that provides unofficial SDKs for:

- **Administration API** - Identity management and administration operations
- **Authentication API** - User authentication and authorization flows
- **Issuance API** - Credential issuance services

## SDK Usage Pattern

The SDKs are generated by `oazapfts` v7.0.1 using the `@oazapfts/runtime` library. This creates a **functional API** (not class-based) with discriminated union return types for type-safe response handling.

### Client Configuration

Each SDK package uses the `defaults` object from `@oazapfts/runtime` for client configuration:

```typescript
import {
  defaults,
  listAuthApiApplicationsUsingGet,
} from "@maccuaa/intellitrust-admin-sdk";

// Configure the client globally
defaults.baseURL = "https://customer.region.trustedauth.com";
defaults.headers = { Authorization: "app_id,secret" };

// Or pass configuration to individual functions
await listAuthApiApplicationsUsingGet({
  baseURL: "https://customer.region.trustedauth.com",
  headers: { Authorization: "app_id,secret" },
});
```

**Note**: The `defaults` object is exported from `index.ts` and allows global configuration of base URLs and headers.

### Response Structure

Functions return an AxiosResponse directly (or throw on error). Access properties directly:

```typescript
const response = await listAuthApiApplicationsUsingGet({ baseURL, headers });
console.log(response.status); // NOT response.response.status
console.log(response.data); // The response body
```

### Parameter Structure

Functions accept an options object with `body`, `path`, `query`, and `headers`:

```typescript
await createTokenUsingPost({
  baseURL: "https://example.com",
  headers: { Authorization: "app_id,secret" },
  path: {
    userid: "user123", // Note: lowercase parameter names from OpenAPI spec
    type: "GOOGLE_AUTHENTICATOR",
  },
  body: {
    // Optional body parameters
  },
});
```

### Path Parameters

Path parameter names match the OpenAPI specification exactly (often lowercase):

- `userid` not `userId`
- `tokenid` not `tokenId`
- `authenticator` not `authType`

## Architecture

### Repository Structure

- **`packages/`** - Bun workspace packages containing three generated SDKs:
  - `admin-sdk/` - Administration API SDK
  - `auth-sdk/` - Authentication API SDK
  - `issuance-sdk/` - Issuance API SDK
- **`bin/`** - Build scripts (download OpenAPI specs, generate SDKs)
- **`tests/`** - End-to-end test files (part of root project, not a workspace)

### Technology Stack

- **Runtime**: Bun (JavaScript/TypeScript runtime)
- **Code Generation**: `oazapfts` v7.0.1 (programmatic API)
- **Linting**: BiomeCLI tool via `bunx`)
- **Build Tool**: `bunup` v0.15.14 (for ESM bundling and type declaration generation)
- **Linting**: Biome v2.3.4Script with type definitions
- **Package Manager**: Bun (with workspaces and isolated installs)
- **HTTP Client**: `@oazapfts/runtime` library

## Key Workflows

### SDK Generation Process

The generation process consists of these steps for each SDK package:

1. **Clean**: Remove all files except `package.json`, `tsconfig.json`, and `README.md` from the SDK directory
2. **Generate**: Run `bunx oazapfts [spec.json] index.ts --argumentStyle object` to generate TypeScript SDK code
3. **Install**: Run `bun install --cwd [sdk-dir]` to install dependencies (required for isolated installs)
4. **Build**: Use `bunup` to:
   - Bundle TypeScript to ESM format
   - Generate type declarations with `inferTypes` and `tsgo` options
   - Create sourcemaps
   - Validate exports with `exports()` plugin
   - Tree-shake unused code with `unused()` plugin
5. **Output**: Generates `dist/` directory with `index.js`, `index.d.ts`, and sourcemaps

**Key Commands:**
Runs `bin/generate.ts` which uses `oazapfts` CLI to generate TypeScript SDK code from OpenAPI specs

3. **Validate SDKs**

   ```bash
   bun run validate
   ```

   Runs validation checks on generated SDK packages (using `@arethetypeswrong/cli` and `publint`)

5

```bash
bun run download
```

Fetches the latest OpenAPI JSON specs from Entrust IDaaS APIs

2. **Generate SDKs**

   ```bash
   bun run build
   ```

   Uses `oazapfts` library's `generateSource()` function to create TypeScript SDK code directly from OpenAPI specs

3. **Lint & Format**

   ```bash
   bun run lint:fix
   ```

   Applies Biome code formatting and linting rules

4. **Test**
   ```bash
   bun test
   ```
   Runs end-to-end tests against the SDKs

### Publishing Workflow

1. Create a git tag matching the IDaaS release version (e.g., `v5.XX`)
2. Push the tag to trigger GitHub Actions
3. Create a GitHub Release
4. Packages are published to NPM under `@maccuaa/intellitrust-*-sdk`

**Publishing Process:**

- Loops through each SDK package (admin-sdk, auth-sdk, issuance-sdk)
- Uses `bun pm pack` to create tarball with resolved catalog dependencies
- Publishes tarball via `npm publish` (provenance attestations are automatic with OIDC trusted publishing)
- Cleans up tarballs after publishing
- This approach maintains security while properly handling catalog references

### Release Monitoring

- The `new-release.yml` workflow runs nightly and on dispatch; it runs `bun run download` and extracts `.info.version` from `openapi/authentication.json` to open a PR bumping the IDaaS OpenAPI files.

## Important Files

- **`biome.json`** - Linting and formatting rules
- **`package.json`** - Workspace and dependency configuration (includes catalog for shared dependencies)
- **`tsconfig.json`** - TypeScript configuration
- **`bunfig.toml`** - Bun runtime configuration
- **`bin/generate.ts`** - SDK generation script (orchestrates the build process)
- **`bin/download.ts`** - OpenAPI spec download script
- **`bin/clean.ts`** - Directory cleaning utility (preserves specific files)
- **`bin/lib.ts`** - Shared utilities and configuration helpers
- **`bin/validate.ts`** - SDK package validation script
- **`openapi/*.json`** - Downloaded OpenAPI specifications
- **`packages/*/package.json`index.ts`) - These are **GENERATED\*\* files. Do not edit directly. All files are generated by `oazapfts` CLI via `bunx` command

## Guidelines for AI Agents

### Maintaining Documentation

**IMPORTANT**: When making changes to the project, update this AGENTS.md file to reflect:

- Changes to the build process or SDK generation workflow
- Updates to dependencies (especially major version changes)
- Changes to project structure or file organization
- New tools or technology stack changes
- Modified commands or workflows
- New troubleshooting scenarios discovered

Keep the documentation accurate and synchronized with the actual implementation to help future AI agents and human contributors.

### When Making Changes

1. **SDK Code** (`packages/*/*.gen.ts`, `index.ts`) - These are **GENERATED** files. Do not edit directly. All files are generated by `oazapfts` using its programmatic `generateSource()` API.

2. **OpenAPI Specs** - The `openapi/*.json` files are downloaded from Entrust. Update via `bun run download`.

3. **Build Scripts** - Files in `bin/` control the generation process. The `bin/generate.ts` script:

   - Cleans SDK directories (preserving `package.json`, `tsconfig.json`, and `README.md`)
   - Runs `oazapfts` CLI via `bunx` with `--argumentStyle object` flag to generate TypeScript code directly to `index.ts`
   - Installs dependencies for each SDK package (required for Bun's isolated installs)
   - Builds via `bunup` with ESM format, sourcemaps, and type declarations (`inferTypes + tsgo`)
   - Uses `bunup` plugins: `exports()` for package.json validation and `unused()` for tree-shaking

4. **Testing** - Test files are in `tests/*.test.ts` (flat structure, no subdirectories). All tests use the functional SDK pattern.

### Common Tasks

- **Add new API endpoint support**: Update happens automatically when OpenAPI specs are updated via `bun run download`
- **Customize generated code**: Would require modifying the oazapfts library or using its plugin system
- **Add new SDK package**: Would require updating `bin/generate.ts` and adding new package directory
- **Fix SDK bugs**: Check if the issue is in the OpenAPI spec itself or in the oazapfts code generation
- **Update dependencies**: Modify the workspace catalog in root `package.json` and run `bun install`

## Troubleshooting

### Common Issues

1. **Missing `index.ts` error during build**

   - Ensure the oazapfts generation step completed successfully
   - Check that the output filename in the `bunx oazapfts` command is `index.ts`
   - Verify that the clean step preserves necessary files

2. **Type errors during build**

   - Run `bun install --cwd packages/[sdk-name]` to ensure dependencies are installed
   - Check `@oazapfts/runtime` version in workspace catalog
   - Verify TypeScript version compatibility

3. **Validation failures**

   - Run `bun run validate` to see detailed errors
   - Check package.json `exports` field matches actual build output
   - Verify `dist/` directory contains expected files

4. **Publishing errors**
   - Ensure `bun pm pack` successfully resolves catalog references
   - Check npm authentication and OIDC trusted publishing setup
   - Verify version numbers follow semantic versioning

### Debug Tips

- Use `bunx oazapfts --help` to see available CLI options
- Check bunup build output for warnings about unused exports
- Run `bun test` to validate SDK functionality before publishing
- Use `@arethetypeswrong/cli` to catch type declaration issues early

### Testing Changes

- Run `bun run build` to regenerate SDKs after template changes
- Run `bun test` to execute e2e tests
- Test changes with `bun run lint` before committing

### Dependency Management

This project uses Bun's **workspace catalogs** to centralize dependency versions:

- **Catalog dependencies**: `typescript` and `axios` versions are defined once in the root `package.json` catalog
- **Usage**: All SDK packages reference catalog versions using `"catalog:"` protocol
- **Benefits**: Single source of truth for versions, easier updates across all packages
- **Updating versions**: To update axios or typescript, modify the version in the root `package.json` catalog and run `bun install`

**Example catalog entry:**
@oazapfts/runtime": "^1.1.0"
}
}

```

**Note**: The project uses `@oazapfts/runtime` (not axios) as the HTTP client, which is shared across all SDK packages via the catalog.catalog": {
    "typescript": "^5.9.2",
    "axios": "1.12.2"
  }
}`oazapfts` CLI up to date
- Monitor `renovate.json`

**Important notes:**

- When publishing SDKs, the workflow uses `bun pm pack` to create tarballs (which resolves `"catalog:"` references to actual version numbers), then publishes those tarballs with `npm publish` to maintain OIDC trusted publishing support
- **Why this two-step process?** Bun's `bun pm pack` resolves catalog references, but `bun publish` doesn't support npm's OIDC trusted publishing (provenance attestations are automatic with `npm publish` when using trusted publishing)
- Keep Bun and OpenAPI Generator CLI up to date
- Monitor renovate.json for automated dependency updates

### Bun Isolated Installs

This project uses Bun's **isolated installs** (default since Bun 1.3) which provides strict dependency isolation similar to pnpm:

- **Benefits**: Prevents phantom dependencies, ensures deterministic builds, better workspace isolation
- **Build Process**: The `bin/generate.ts` script installs dependencies in each SDK package after code generation but before building
- **Workspace References**: Dev dependencies reference SDK packages using `workspace:*` protocol
- **Type Checking**: TypeScript compilation happens during the `bunup` build step

**Important**: Do not switch to hoisted installs unless absolutely necessary. The build process is designed to work with isolated installs.

## Generated SDK Structure

Each SDK package follows this structure after generation:

```

packages/[sdk-name]/
├── package.json # Package metadata and exports
├── tsconfig.json # TypeScript configuration
├── README.md # SDK documentation
├── index.ts # Generated SDK code (DO NOT EDIT)
├── node_modules/ # Isolated dependencies
└── dist/ # Build output
├── index.js # ESM bundle
├── index.d.ts # Type declarations
└── index.js.map # Source maps

```

**Note**: Only `dist/` and `README.md` are published to npm (see `files` field in `package.json`).

## Project Conventions

- Uses Bun workspaces for monorepo management
- NPM packages are scoped under `@maccuaa/`
- Follows semantic versioning aligned with Entrust IDaaS releases
- All generated code includes DO NOT MODIFY headers
- TypeScript strict mode enabled
- ESM-only modules (no CommonJS)
- Community-maintained, not officially supported by Entrust

## Version Information

- **Bun**: Latest stable (1.3+)
- **oazapfts**: 7.0.1
- **bunup**: 0.15.14
- **Biome**: 2.3.4
- **TypeScript**: 5.9.2+
- **@oazapfts/runtime**: 1.1.0+

## Resources

- [Entrust IDaaS Documentation](https://entrust.us.trustedauth.com/help/developer/)
- [oazapfts Documentation](https://www.npmjs.com/package/oazapfts)
- [Bun Runtime](https://bun.sh/)
- [Bun Workspaces](https://bun.sh/docs/install/workspaces)
- [bunup Build Tool](https://www.npmjs.com/package/bunup)
- [Biome Linter](https://biomejs.dev/)
- [@oazapfts/runtime](https://www.npmjs.com/package/@oazapfts/runtime)
```
